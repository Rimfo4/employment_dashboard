import streamlit as st
import pandas as pd
import plotly.graph_objects as go
import requests
from streamlit_lottie import st_lottie
import time

# --- í˜ì´ì§€ ê¸°ë³¸ ì„¤ì • ---
st.set_page_config(
    page_title="ê¸°í›„ë³€í™”ì™€ ì·¨ì—… ë³´ê³ ì„œ",
    page_icon="ğŸŒ",
    layout="wide",
)

# --- ì•ˆì •ì„±ì„ ë†’ì¸ Lottie ë¡œë”© í•¨ìˆ˜ ---
@st.cache_data(ttl=3600) # 1ì‹œê°„ ë™ì•ˆ ë°ì´í„° ìºì‹œ
def load_lottieurl(url: str):
    """ì¬ì‹œë„ ê¸°ëŠ¥ì´ í¬í•¨ëœ ì•ˆì •ì ì¸ Lottie ì• ë‹ˆë©”ì´ì…˜ ë°ì´í„° ë¡œë”© í•¨ìˆ˜"""
    for _ in range(3): # ìµœëŒ€ 3ë²ˆ ì¬ì‹œë„
        try:
            r = requests.get(url, timeout=10)
            if r.status_code == 200:
                return r.json()
        except requests.exceptions.RequestException as e:
            time.sleep(1) # ì¬ì‹œë„ ì „ 1ì´ˆ ëŒ€ê¸°
    return None # ëª¨ë“  ì¬ì‹œë„ ì‹¤íŒ¨ ì‹œ None ë°˜í™˜

# --- ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ CSS ---
st.markdown("""
<style>
h1, h2, h3 {
    opacity: 0;
    animation: fadeIn 1s ease-in-out forwards;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
""", unsafe_allow_html=True)

# --- ë°ì´í„° ë¡œë”© (ìºì‹±) ---
@st.cache_data
def get_report_data():
    """ë³´ê³ ì„œë¥¼ ìœ„í•œ ì‹œê³„ì—´ ì˜ˆì‹œ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    data = []
    # ì°¸ê³ : 2025ë…„ 9ì›” 16ì¼ í˜„ì¬, 2030ë…„ì€ ë¯¸ë˜ ë°ì´í„°ì…ë‹ˆë‹¤.
    # ì•±ì˜ ë¡œì§ìƒ ë¯¸ë˜ ë°ì´í„°ëŠ” í•„í„°ë§ë˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ì˜ˆì‹œë¡œë§Œ í¬í•¨í•©ë‹ˆë‹¤.
    for year in [2020, 2024, 2025]:
        data.extend([
            {'ì—°ë„': year, 'ìœ í˜•': 'ì‹ ì¬ìƒì—ë„ˆì§€', 'ì¦ê°ë¥ ': 12 + (year - 2020) * 1.8, 'êµ¬ë¶„': 'ì„±ì¥'},
            {'ì—°ë„': year, 'ìœ í˜•': 'ì „ê¸°ì°¨ ìƒì‚°', 'ì¦ê°ë¥ ': 10 + (year - 2020) * 1.5, 'êµ¬ë¶„': 'ì„±ì¥'},
            {'ì—°ë„': year, 'ìœ í˜•': 'í™”ë ¥ë°œì „', 'ì¦ê°ë¥ ': -9 - (year - 2020) * 1.2, 'êµ¬ë¶„': 'ê°ì†Œ'},
            {'ì—°ë„': year, 'ìœ í˜•': 'ì„ìœ í™”í•™', 'ì¦ê°ë¥ ': -7 - (year - 2020) * 1.0, 'êµ¬ë¶„': 'ê°ì†Œ'},
            {'ì—°ë„': year, 'ì „ê³µ': 'ì¹œí™˜ê²½Â·ì—ë„ˆì§€', 'ì·¨ì—…ë¥ ': 70 + (year - 2020) * 0.9},
            {'ì—°ë„': year, 'ì „ê³µ': 'ì „ì²´ í‰ê· ', 'ì·¨ì—…ë¥ ': 67 + (year - 2020) * 0.1}
        ])
    return pd.DataFrame(data)

# --- Plotly ê·¸ë˜í”„ í°íŠ¸ ì„¤ì • ---
def plot_with_font(fig):
    fig.update_layout(font_family="Pretendard") # Pretendard í°íŠ¸ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ í°íŠ¸ ì‚¬ìš©
    return fig

# =====================================================================================
# ë©”ì¸ ëŒ€ì‹œë³´ë“œ (ì‹±ê¸€ í˜ì´ì§€ ìŠ¤í¬ë¡¤)
# =====================================================================================
st.title("ê¸°í›„ë¥¼ ì‹ ê²½ì“°ë©´ ì·¨ì—…ì´ ëœë‹¤ê³ ìš”? ğŸ¤”")
st.caption("ê¸°í›„ë³€í™”ê°€ ì²­ì†Œë…„ì˜ ì§„ë¡œì™€ ì·¨ì—…ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ ë¶„ì„ ë³´ê³ ì„œ")

# --- ë°ì´í„° ë¡œë“œ ë° ì‚¬ì´ë“œë°” ---
full_df = get_report_data()
st.sidebar.title("ë³´ê³ ì„œ ì˜µì…˜ âš™ï¸")
selected_year = st.sidebar.selectbox(
    'ê¸°ì¤€ ì—°ë„ ì„ íƒ',
    options=full_df['ì—°ë„'].unique(),
    index=len(full_df['ì—°ë„'].unique()) - 1
)
filtered_df = full_df[full_df['ì—°ë„'] == selected_year].copy()

# --- 1. ì„œë¡  (ë¬¸ì œ ì œê¸°) ---
st.header("ğŸ“‘ ì„œë¡ : ê¸°í›„ë³€í™”, ë” ì´ìƒ í™˜ê²½ ë¬¸ì œë§Œì´ ì•„ë‹™ë‹ˆë‹¤")
st.markdown("""
ê¸°í›„ë³€í™”ëŠ” ë‹¨ìˆœíˆ í™˜ê²½ ë¬¸ì œë¥¼ ë„˜ì–´ì„œ, **ì²­ì†Œë…„ ì„¸ëŒ€ì˜ ì§„ë¡œì™€ ì·¨ì—…ì—ë„ í° ì˜í–¥ì„ ë¯¸ì¹˜ê³  ìˆìŠµë‹ˆë‹¤.**
ê¸°í›„ ìœ„ê¸°ì— ëŒ€ì‘í•˜ê¸° ìœ„í•œ ì‚°ì—… êµ¬ì¡° ë³€í™”ì™€ ì‹ ì¬ìƒì—ë„ˆì§€ í™•ëŒ€, íƒ„ì†Œì¤‘ë¦½ ì •ì±…ì€ ë…¸ë™ì‹œì¥ì˜ ìˆ˜ìš”ë¥¼ ë¹ ë¥´ê²Œ ì¬í¸í•˜ê³  ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
ê³ ìš©ë…¸ë™ë¶€ ìë£Œì— ë”°ë¥´ë©´ **ë…¹ìƒ‰ ì¼ìë¦¬ëŠ” ìµœê·¼ 5ë…„ê°„ ê¾¸ì¤€íˆ ì¦ê°€**í–ˆê³ , ë°˜ëŒ€ë¡œ í™”ì„ì—°ë£Œ ê¸°ë°˜ ì‚°ì—… ì¼ìë¦¬ëŠ” ê°ì†Œì„¸ë¥¼ ë³´ì˜€ìŠµë‹ˆë‹¤.
> ë”°ë¼ì„œ ê¸°í›„ë³€í™”ëŠ” **ë¯¸ë˜ ì‚¬íšŒì˜ ì·¨ì—… í™˜ê²½ì„ ê²°ì •ì§“ëŠ” í•µì‹¬ ìš”ì¸**ìœ¼ë¡œ, ì²­ì†Œë…„ ì„¸ëŒ€ê°€ ë°˜ë“œì‹œ ì£¼ëª©í•´ì•¼ í•˜ëŠ” ë¬¸ì œì…ë‹ˆë‹¤.
""")
st.divider()

# --- 2. ë³¸ë¡  1 (ë°ì´í„° ë¶„ì„) ---
lottie_data = load_lottieurl("https://lottie.host/e70f61d5-9493-424a-9383-9975a6c12202/66f8p4e5Wv.json")
if lottie_data:
    st_lottie(lottie_data, speed=1, height=200, key="data_analysis")
else:
    st.warning("âš ï¸ ë°ì´í„° ë¶„ì„ ì• ë‹ˆë©”ì´ì…˜ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

st.header(f"ğŸ“Š ë³¸ë¡  1: {selected_year}ë…„, ë°ì´í„°ë¡œ ë³´ëŠ” ê¸°í›„ ìœ„ê¸°ì™€ ì¼ìë¦¬ì˜ ë³€í™”")
st.write("ê¸°í›„ ìœ„ê¸°ëŠ” ì‚°ì—… êµ¬ì¡°ì™€ ì·¨ì—…ë¥ ì˜ ë³€í™”ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤. ì •ë¶€ëŠ” 2050 íƒ„ì†Œì¤‘ë¦½ì„ ëª©í‘œë¡œ ìˆ˜ì‹­ë§Œ ê°œì˜ ë…¹ìƒ‰ ì¼ìë¦¬ë¥¼ ì°½ì¶œí•  ê³„íšì´ë¼ê³  ë°œí‘œí–ˆìœ¼ë©°, ì•„ë˜ ë°ì´í„°ëŠ” ê·¸ ë³€í™”ì˜ ë‹¨ë©´ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.")

st.subheader("1. 'ë…¹ìƒ‰ ì „í™˜'ì— ë”°ë¥¸ ì‚°ì—…ë³„ ì¼ìë¦¬ ì „ë§")
col1, col2 = st.columns([0.6, 0.4])
with col1:
    industry_df = filtered_df[filtered_df['êµ¬ë¶„'].isin(['ì„±ì¥', 'ê°ì†Œ'])].copy()
    fig1 = go.Figure(go.Sunburst(
        labels=["ë…¹ìƒ‰ ì „í™˜", "ì„±ì¥ ì‚°ì—…", "ê°ì†Œ ì‚°ì—…", *industry_df['ìœ í˜•']],
        parents=["", "ë…¹ìƒ‰ ì „í™˜", "ë…¹ìƒ‰ ì „í™˜", "ì„±ì¥ ì‚°ì—…", "ì„±ì¥ ì‚°ì—…", "ê°ì†Œ ì‚°ì—…", "ê°ì†Œ ì‚°ì—…"],
        values=[0, sum(industry_df[industry_df['êµ¬ë¶„']=='ì„±ì¥']['ì¦ê°ë¥ ']), sum(abs(industry_df[industry_df['êµ¬ë¶„']=='ê°ì†Œ']['ì¦ê°ë¥ '])),
                *industry_df['ì¦ê°ë¥ '].abs()],
        branchvalues="total",
        marker=dict(colors=['#2ECC71', '#E74C3C', '#2ECC71', '#2ECC71', '#E74C3C', '#E74C3C']),
        hoverinfo='label+percent parent'
    ))
    fig1.update_layout(title=f'<b>{selected_year}ë…„ ë…¹ìƒ‰ ì „í™˜ ì˜í–¥ ë¶„ì„</b>', margin=dict(t=50, l=10, r=10, b=10))
    st.plotly_chart(plot_with_font(fig1), use_container_width=True)
with col2:
    growth_sectors = industry_df[industry_df['êµ¬ë¶„'] == 'ì„±ì¥']
    decline_sectors = industry_df[industry_df['êµ¬ë¶„'] == 'ê°ì†Œ']
    st.markdown("<br>", unsafe_allow_html=True)
    st.metric(label=f"ğŸŸ¢ {growth_sectors.iloc[0]['ìœ í˜•']} ì¼ìë¦¬ ì „ë§", value=f"{growth_sectors.iloc[0]['ì¦ê°ë¥ ']:.1f}%")
    st.metric(label=f"ğŸŸ¢ {growth_sectors.iloc[1]['ìœ í˜•']} ì¼ìë¦¬ ì „ë§", value=f"{growth_sectors.iloc[1]['ì¦ê°ë¥ ']:.1f}%")
    st.metric(label=f"ğŸ”´ {decline_sectors.iloc[0]['ìœ í˜•']} ì¼ìë¦¬ ì „ë§", value=f"{decline_sectors.iloc[0]['ì¦ê°ë¥ ']:.1f}%")
    st.metric(label=f"ğŸ”´ {decline_sectors.iloc[1]['ìœ í˜•']} ì¼ìë¦¬ ì „ë§", value=f"{decline_sectors.iloc[1]['ì¦ê°ë¥ ']:.1f}%")

st.subheader("2. ì¹œí™˜ê²½ ê´€ë ¨ ì „ê³µ, ì·¨ì—… ì‹œì¥ì˜ 'ë¸”ë£¨ì¹©'ìœ¼ë¡œ ë¶€ìƒ")
major_df = filtered_df[filtered_df['ì „ê³µ'].isin(['ì¹œí™˜ê²½Â·ì—ë„ˆì§€', 'ì „ì²´ í‰ê· '])].copy()
major_rate = major_df.loc[major_df['ì „ê³µ'] == 'ì¹œí™˜ê²½Â·ì—ë„ˆì§€', 'ì·¨ì—…ë¥ '].iloc[0]
avg_rate = major_df.loc[major_df['ì „ê³µ'] == 'ì „ì²´ í‰ê· ', 'ì·¨ì—…ë¥ '].iloc[0]

fig2 = go.Figure(go.Indicator(
    mode="gauge+number+delta", value=major_rate,
    title={'text': f"<b>ì¹œí™˜ê²½Â·ì—ë„ˆì§€ ì „ê³µ ì·¨ì—…ë¥  ({selected_year}ë…„)</b>"},
    delta={'reference': avg_rate, 'suffix': '%p', 'relative': False},
    gauge={'axis': {'range': [60, 90]}, 'bar': {'color': "#27AE60"},
           'steps': [{'range': [60, 70], 'color': "lightgray"}, {'range': [70, 80], 'color': "gray"}],
           'threshold': {'line': {'color': "red", 'width': 4}, 'thickness': 0.75, 'value': avg_rate}}))
fig2.update_layout(height=400)
st.plotly_chart(plot_with_font(fig2), use_container_width=True)
st.info("ypec ì²­ì†Œë…„ í†µê³„ í¬í„¸ ë°ì´í„°ì— ë”°ë¥´ë©´, ì¹œí™˜ê²½Â·ì—ë„ˆì§€ ê´€ë ¨ ì „ê³µìì˜ ì·¨ì—…ë¥ ì€ ì „ì²´ í‰ê· ë³´ë‹¤ ë†’ê²Œ ë‚˜íƒ€ë‚˜ë©°, ì´ëŠ” ê¸°í›„ ë³€í™”ê°€ ìœ ë§ ì „ê³µì˜ ì§€í˜•ë„ë¥¼ ë°”ê¾¸ê³  ìˆìŒì„ ì‹œì‚¬í•©ë‹ˆë‹¤.")
st.divider()

# --- 3. ë³¸ë¡  2 (ì›ì¸ê³¼ ì˜í–¥) ---
lottie_cause = load_lottieurl("https://lottie.host/1f7a93a3-1191-42ea-a0d0-55b634860010/89a5p8M6pI.json")
if lottie_cause:
    st_lottie(lottie_cause, speed=1, height=200, key="cause_effect")
else:
    st.warning("âš ï¸ ì›ì¸ ë¶„ì„ ì• ë‹ˆë©”ì´ì…˜ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

st.header("ğŸ” ë³¸ë¡  2: ê¸°í›„ ìœ„ê¸°ëŠ” ì–´ë–»ê²Œ ì·¨ì—… ì‹œì¥ì„ ë°”ê¾¸ëŠ”ê°€?")
st.markdown("""
### ì›ì¸: ê±°ìŠ¤ë¥¼ ìˆ˜ ì—†ëŠ” íë¦„, 'ë…¹ìƒ‰ ì „í™˜(Green Transition)'
ê¸°í›„ ìœ„ê¸°ê°€ ì·¨ì—…ì— ì˜í–¥ì„ ì£¼ëŠ” ì›ì¸ì€ â€˜ë…¹ìƒ‰ ì „í™˜â€™ì…ë‹ˆë‹¤. ê¸°ì—…ê³¼ ì‚¬íšŒê°€ ê¸°í›„ ëŒ€ì‘ì„ ìœ„í•´ ì¹œí™˜ê²½ ê¸°ìˆ ì„ ë„ì…í•˜ê³ , ìƒˆë¡œìš´ ì§ë¬´ë¥¼ ë§Œë“¤ì–´ë‚´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
- **ê¸°ì—…ì˜ ë³€í™”**: ê¸°ì‚¬ ë³´ë„ì— ë”°ë¥´ë©´ ëŒ€ê¸°ì—…ë“¤ì€ **ESG ê²½ì˜**ì„ í™•ëŒ€í•˜ë©° í™˜ê²½Â·ì—ë„ˆì§€ ë¶„ì•¼ ì¸ì¬ë¥¼ ì ê·¹ì ìœ¼ë¡œ ì±„ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.
- **ìƒˆë¡œìš´ ì‹œì¥**: ê¸°í›„Â·í™˜ê²½ ìŠ¤íƒ€íŠ¸ì—…ë„ ë¹ ë¥´ê²Œ ì„±ì¥í•˜ë©´ì„œ ì²­ë…„ë“¤ì˜ ì§„ì… ê¸°íšŒê°€ ë„“ì–´ì§€ê³  ìˆìŠµë‹ˆë‹¤.
### ì˜í–¥: ìœ„í—˜ê³¼ ê¸°íšŒì˜ ê³µì¡´
> ê²°êµ­ ê¸°í›„ ìœ„ê¸°ëŠ” ì²­ë…„ë“¤ì—ê²Œ **â€˜ìœ„í—˜â€™ê³¼ â€˜ê¸°íšŒâ€™ë¥¼ ë™ì‹œì—** ë˜ì ¸ì£¼ê³  ìˆìœ¼ë©°, ë³€í™”ì— ì–´ë–»ê²Œ ì¤€ë¹„í•˜ëŠëƒê°€ ë¯¸ë˜ ì·¨ì—…ì˜ ì„±íŒ¨ë¥¼ ì¢Œìš°í•˜ê²Œ ë©ë‹ˆë‹¤.
""")
st.divider()

# --- 4. ê²°ë¡  (ì œì–¸) ---
lottie_conclusion = load_lottieurl("https://lottie.host/7e05e830-7456-4c31-b844-93b5a1b55909/Rk4yQO6fS3.json")
if lottie_conclusion:
    st_lottie(lottie_conclusion, speed=1, height=200, key="conclusion_idea")
else:
    st.warning("âš ï¸ ê²°ë¡  ì• ë‹ˆë©”ì´ì…˜ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

st.header("ğŸš€ ê²°ë¡ : ê¸°í›„ ìœ„ê¸°ë¥¼ ê¸°íšŒë¡œ, ë¯¸ë˜ë¥¼ ì¤€ë¹„í•˜ëŠ” ì²­ì†Œë…„ì˜ ìì„¸")
st.markdown("ìš°ë¦¬ëŠ” ë‹¤ìŒ ì„¸ ê°€ì§€ ì‹¤ì²œì„ ì œì•ˆí•©ë‹ˆë‹¤.")
c1, c2, c3 = st.columns(3)
with c1:
    st.success("#### ì œì–¸ 1: ê¸°í›„ ë°ì´í„° íƒì‚¬ëŒ€", icon="ğŸ•µï¸")
    st.write("ê¸°í›„ ë°ì´í„°ì™€ ì‚°ì—… í†µê³„ë¥¼ ì§ì ‘ ì°¾ì•„ ë¶„ì„í•˜ë©°, ë³€í™”í•˜ëŠ” ì·¨ì—… í™˜ê²½ì„ íƒêµ¬í•©ë‹ˆë‹¤.")
with c2:
    st.success("#### ì œì–¸ 2: ê·¸ë¦° IT í”„ë¡œì íŠ¸", icon="ğŸ’»")
    st.write("ì†Œí”„íŠ¸ì›¨ì–´ê³¼ í•™ìƒìœ¼ë¡œì„œ ê¸°í›„ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ëŠ” í”„ë¡œê·¸ë¨ì„ ë§Œë“¤ê±°ë‚˜, ì—ë„ˆì§€ ì ˆì•½ì„ ìœ„í•œ ì•± ì•„ì´ë””ì–´ë¥¼ êµ¬ìƒí•©ë‹ˆë‹¤.")
with c3:
    st.success("#### ì œì–¸ 3: ì²­ì†Œë…„ì˜ ëª©ì†Œë¦¬", icon="ğŸ“£")
    st.write("í•™ìƒíšŒë‚˜ ì§€ì—­ ì²­ì†Œë…„ ê¸°êµ¬ë¥¼ í†µí•´, â€˜ê¸°í›„ ìœ„ê¸° ëŒ€ì‘ì´ ê³§ ì²­ë…„ ê³ ìš© ì°½ì¶œâ€™ì„ì„ ì•Œë¦¬ê³  ì •ì±… ì œì•ˆì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
st.divider()

# --- 5. ì°¸ê³  ìë£Œ ---
st.header("ğŸ“š ì°¸ê³  ìë£Œ")
st.markdown("""
- **ëŒ€í•™ì§„í•™ë¥  ë° ì·¨ì—…ë¥  ê·¸ë˜í”„**, ì—¬ì„±ê°€ì¡±ë¶€ (ypec ì²­ì†Œë…„ í†µê³„ í¬í„¸)
- **ê¸°í›„ë³€í™” 4ëŒ€ì§€í‘œ**, íƒ„ì†Œì¤‘ë¦½ ì •ì±…í¬í„¸
- **í–¥í›„ 10ë…„ ì‚¬ë¼ì§ˆ ì§ì—… 1ìœ„ëŠ”?**, í¬ì¼“ë‰´ìŠ¤ ë‹¤ìŒì±„ë„
- **ì£¼ìš” ì—…ì¢… ì¼ìë¦¬ ê·¸ë˜í”„**, ê³ ìš©ë…¸ë™ë¶€
""")